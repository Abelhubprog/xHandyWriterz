# syntax=docker/dockerfile:1.6

FROM node:20-alpine AS builder
ENV PNPM_HOME=/root/.local/share/pnpm
ENV PATH=$PNPM_HOME:$PATH
RUN corepack enable

WORKDIR /app

COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
RUN mkdir -p apps/web
COPY apps/web/package.json apps/web/package.json

RUN pnpm install --filter @handywriterz/web... --no-frozen-lockfile

COPY . .

RUN pnpm --filter @handywriterz/web... build

FROM node:20-alpine AS runner
ENV NODE_ENV=production
WORKDIR /app

COPY --from=builder /app/apps/web/dist ./dist
COPY --from=builder /app/apps/web/scripts ./scripts

EXPOSE 4173

CMD ["node", "scripts/server.mjs"]
